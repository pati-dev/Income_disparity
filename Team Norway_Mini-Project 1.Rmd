---
title: "Mini-Project 1_Team Norway"
author: "Ankit Mathur, Nitesh Jaswal, Akshay Rathi"
date: "1/31/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, warning = FALSE, echo = FALSE)
library(tidyverse)
library(foreign)
library(data.table)
library(broom)
```

# Correlation between mean income and percentage share of income earned by the top 5% segment

```{r}
# Load the data
ventile = read.dta("ventile_2011_for_release_LCU.dta")
conv = read.csv("curr_conv.csv", stringsAsFactors = FALSE)
 
# Convert all local currencies to corresponding USD 2012 dollars (not adjusted for inflation)
ventile.adj <- merge(ventile, conv, by = "contcod", all.x = TRUE)
ventile.adj$ventile_income_adj = ventile.adj$ventile_income * ventile.adj$conv_fac
ventile.adj$continent <- replace_na(ventile.adj$continent, "NA")
ventile.adj$continent <- as.factor(ventile.adj$continent)
levels(ventile.adj$continent) <- c("Africa", "Asia", "Europe", "North America", "Oceania", "South America")

# Create a function to produce % shares and mean incomes for a given ventile for all countries
plot_v <- function(ventile, v) {
  ventile.dt = data.table(ventile)
  setkey(ventile.dt, ventile)
  ventile.v = ventile.dt[ .(v), list(totpop, v_income = ventile_income_adj * pop), by = list(contcod, continent) ]
  ventile.tot = ventile.dt[, list( tot_income = sum(ventile_income_adj * pop) ), by = list(contcod)]
  ventile.v <- merge(ventile.v, ventile.tot, by = "contcod", all.x = TRUE)
  
  ventile.v$perc_share = ventile.v$v_income * 100 / ventile.v$tot_income
  ventile.v$avg_income = ventile.v$tot_income / ventile.v$totpop
  ventile.v$dev = (ventile.v$avg_income >= 12000)
  ventile.v$dev <- as.factor(ventile.v$dev)
  levels(ventile.v$dev) <- c("Developing", "Developed")
  return(ventile.v)
}
```


```{r}
# Plots for top 5%
ventile.top5 = plot_v(ventile.adj, 20)

ggplot(ventile.top5, aes(x = perc_share, y = avg_income)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", aes(fill = "Trend"), color = "#009E73", se = FALSE) +
  facet_wrap(~ continent) +
  ylab("Mean income \n(equivalent to 2012 USD)") +
  xlab("% income share") +
  ggtitle("Variation of mean incomes of countries by %age share of income \nheld by the top 5% individuals") +
  labs(subtitle = "Based upon data maintained by Branko Milanovic of the Stone Center on \nSocioEconomic Inequality for 111 countries") +
  scale_fill_manual(name = "", values = c("Trend" = "#009E73")) +
  theme(legend.position = "right")
```

```{r}
ggplot(ventile.top5, aes(x = perc_share, y = avg_income)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", aes(fill = "Trend"), color = "#009E73", se = FALSE) +
  facet_wrap(~ dev) +
  ylab("Mean income \n(equivalent to 2012 USD)") +
  xlab("% income share") +
  ggtitle("Variation of mean incomes of countries by %age share of income \nheld by the top 5% individuals") +
  labs(subtitle = "Based upon data maintained by Branko Milanovic of the Stone Center on \nSocioEconomic Inequality for 111 countries") +
  scale_fill_manual(name = "", values = c("Trend" = "#009E73")) +
  theme(legend.position = "right")
```


Mean incomes of developing countries in Asia, Africa, and South America do not show a strong relation with the percentage share of income held by the top 5% individuals. However, the mean incomes of developed countries in North America and Europe ten
do tend to decrease as the %age share of income held by the top 5% segment increases. This negative correlation is much sharper in North America than in Europe owing to United States and Canada, both of which have much higher average income than the rest of the countries in North America.

```{r}
# Plot residuals for top 5%
ventile.top5.lm = lm(avg_income ~ perc_share*dev, data = ventile.top5)
ventile.top5.lm.df = augment(ventile.top5.lm)

ggplot(ventile.top5.lm.df, aes(x = perc_share, y = .resid)) +
  geom_point(alpha = 0.1) +
  geom_smooth(aes(fill = "Trend"), color = "#009E73", se = TRUE) +
  facet_wrap(~ dev) +
  ylab("Residuals") +
  ggtitle("Residual Plots") +
  scale_fill_manual(name = "", values = c("Trend" = "#009E73")) +
  theme(legend.position = "right")
```

# Correlation between mean income and percentage share of income earned by the bottom 5% segment

```{r}
# Plots for bottom 5%
ventile.bottom5 = plot_v(ventile.adj, 1)

ggplot(ventile.bottom5, aes(x = perc_share, y = avg_income)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", aes(fill = "Trend"), color = "#E69F00", se = FALSE) +
  facet_wrap(~ dev) +
  ylab("Mean income \n(equivalent to 2012 USD)") +
  xlab("% income share") +
  ggtitle("Variation of mean incomes of countries by %age share of income \nheld by the bottom 5% individuals") +
  labs(subtitle = "Based upon data maintained by Branko Milanovic of the Stone Center on \nSocioEconomic Inequality for 111 countries") +
  scale_fill_manual(name = "", values = c("Trend" = "#E69F00")) +
  theme(legend.position = "right")
```

Shares of incomes of the bottom 5% individuals have no effect whatsoever on the mean incomes of countries.


```{r}
# Plot residuals for bottom 5%
ventile.bottom5.lm = lm(avg_income ~ perc_share*dev, data = ventile.bottom5)
ventile.bottom5.lm.df = augment(ventile.bottom5.lm)

ggplot(ventile.bottom5.lm.df, aes(x = perc_share, y = .resid)) +
  geom_point(alpha = 0.1) +
  geom_smooth(aes(fill = "Trend"), color = "#E69F00") +
  facet_wrap(~ dev) +
  ylab("Residuals") +
  ggtitle("Residual Plots") +
  scale_fill_manual(name = "", values = c("Trend" = "#E69F00")) +
  theme(legend.position = "right")
```
---
title: "Mini-Project 1_Team Norway"
author: "Ankit Mathur, Nitesh Jaswal, Akshay Rathi"
date: "1/31/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE)
library(tidyverse)
library(foreign)
library(data.table)
library(broom)
```

# Correlation b/w mean income and top/bottom ventiles

```{r, include=FALSE}
# Load the data
ventile = read.dta("ventile_2011_for_release_LCU.dta")
conv = read.csv("curr_conv.csv", stringsAsFactors = FALSE)

# Convert all local currencies to corresponding USD 2012 dollars (not adjusted for inflation)
ventile.adj <- merge(ventile, conv, by = "contcod", all.x = TRUE)
ventile.adj$ventile_income_adj = ventile.adj$ventile_income * ventile.adj$conv_fac
ventile.adj$continent <- replace_na(ventile.adj$continent, "NA")
ventile.adj$continent <- as.factor(ventile.adj$continent)
levels(ventile.adj$continent) <- c("Africa", "Asia", "Europe", "North America", "Oceania", "South America")

# Create a function to produce % shares and mean incomes for a given ventile for all countries
plot_v <- function(ventile, v) {
  ventile.dt = data.table(ventile)
  setkey(ventile.dt, ventile)
  ventile.v = ventile.dt[ .(v), list(totpop, v_income = ventile_income_adj * pop), by = list(contcod, continent) ]
  ventile.tot = ventile.dt[, list( tot_income = sum(ventile_income_adj * pop) ), by = list(contcod)]
  ventile.v <- merge(ventile.v, ventile.tot, by = "contcod", all.x = TRUE)
  
  ventile.v$perc_share = ventile.v$v_income * 100 / ventile.v$tot_income
  ventile.v$avg_income = ventile.v$tot_income / ventile.v$totpop
  return(ventile.v)
}
```

Plots for top 5%:
```{r}
ventile.top5 = plot_v(ventile.adj, 20)

ggplot(ventile.top5, aes(x = perc_share, y = avg_income)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", aes(fill = "Trend"), color = "#009E73", se = FALSE) +
  facet_wrap(~ continent) +
  ylab("Mean income \n(equivalent to 2012 USD)") +
  xlab("% income share") +
  ggtitle("Variation of mean incomes of countries by %age share of income held by \nthe top 5% individuals") +
  labs(subtitle = "Based upon data maintained by Branko Milanovic of the Stone Center on \nSocioEconomic Inequality for 111 countries") +
  scale_fill_manual(name = "", values = c("Trend" = "#009E73")) +
  theme(legend.position = "bottom")
```

Developed countries with lower income share tend to have higher mean income
Mean income of countries in Asia, Africa, and South America, all of which have relatively low GDP per capita, does not vary with the %age share of income held by the top 5% individuals. However, the mean income of countries in North America and Europe, both of which have much higher GDP per capita, does tend to decrease as the %age share of income held by the top 5% segment increases. This negative correlation is much sharper in North America than in Europe owing to United States and Canada, both of which have much higher average income than the rest of the countries in North America.

Plot residuals for top 5%:
```{r}
ventile.top5.lm = lm(avg_income ~ perc_share*continent, data = ventile.top5)
ventile.top5.lm.df = augment(ventile.top5.lm)

# ggplot(ventile.top5.lm.df, aes(x = perc_share, y = .fitted)) +
#   geom_line() +
#   facet_wrap(~ continent)

ggplot(ventile.top5.lm.df, aes(x = perc_share, y = .resid)) +
  geom_point(alpha = 0.1) +
  geom_smooth(aes(fill = "Trend"), color = "#009E73", se = TRUE) +
  facet_wrap(~ continent) +
  ylab("Residuals") +
  ggtitle("Residual Plots") +
  scale_fill_manual(name = "", values = c("Trend" = "#009E73")) +
  theme(legend.position = "bottom")
```


Plots for bottom 5%:
```{r}
ventile.bottom5 = plot_v(ventile.adj, 1)

ggplot(ventile.bottom5, aes(x = perc_share, y = avg_income)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", aes(fill = "Trend"), color = "#E69F00", se = FALSE) +
  ylab("Mean income \n(equivalent to 2012 USD)") +
  xlab("% income share") +
  ggtitle("Variation of mean incomes of countries by %age share of income held by \nthe bottom 5% individuals") +
  labs(subtitle = "Based upon data maintained by Branko Milanovic of the Stone Center on \nSocioEconomic Inequality for 111 countries") +
  scale_fill_manual(name = "", values = c("Trend" = "#E69F00")) +
  theme(legend.position = "bottom")
```

Shares of incomes of the bottom 5% individuals have no effect whatsoever on the mean incomes of countries.


Plot residuals for bottom 5%:
```{r}
ventile.bottom5.lm = lm(avg_income ~ perc_share, data = ventile.bottom5)
ventile.bottom5.lm.df = augment(ventile.bottom5.lm)

ggplot(ventile.bottom5.lm.df, aes(x = perc_share, y = .resid)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", aes(fill = "Trend"), color = "#E69F00", se = FALSE) +
  ylab("Residuals") +
  ggtitle("Residual Plot") +
  scale_fill_manual(name = "", values = c("Trend" = "#E69F00")) +
  theme(legend.position = "bottom")
```